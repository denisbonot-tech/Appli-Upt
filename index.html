<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Up-T | V6.8 Vertical Feed</title>
    <style>
        :root { --neon-blue: #00f3ff; --bg-dark: #000000; --glass: rgba(255, 255, 255, 0.1); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: var(--bg-dark); font-family: 'Inter', sans-serif; color: white; touch-action: none; }

        /* NAVIGATION & UI */
        #gps-container { position: fixed; bottom: 55px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; z-index: 1001; }
        .dot { width: 5px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 50%; transition: 0.4s; }
        .dot.active { background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue); transform: scale(1.3); }
        #taskbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 45px; background: var(--glass); backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { opacity: 0.3; transition: 0.3s; display: flex; align-items: center; justify-content: center; width: 20%; height: 100%; cursor: pointer; }
        .nav-item.active { opacity: 1; color: var(--neon-blue); }
        .nav-item svg { width: 22px; height: 22px; fill: currentColor; }

        /* VIEWPORT NAVIGATION */
        #main-viewport { display: flex; width: 500vw; height: 100vh; transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1); transform: translateX(-200vw); }
        .page { width: 100vw; height: 100vh; flex-shrink: 0; position: relative; display: flex; flex-direction: column; overflow: hidden; }

        /* FEED VERTICAL (CARROSSE) */
        #carrosse-feed { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
        .post-card { width: 100vw; height: 100vh; position: relative; scroll-snap-align: start; background: #000; flex-shrink: 0; }
        .post-card img { width: 100%; height: 100%; object-fit: cover; }
        
        .post-info { position: absolute; bottom: 120px; left: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }
        .post-author { font-weight: 900; color: var(--neon-blue); font-size: 1.1rem; }

        .vote-section { position: absolute; bottom: 180px; right: 20px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .vote-btn { width: 52px; height: 52px; background: white; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 15px rgba(0,243,255,0.4); cursor: pointer; }
        .vote-btn svg { width: 24px; fill: black; }
        .vote-counter { font-weight: 900; background: rgba(0,0,0,0.6); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; backdrop-filter: blur(5px); }

        .fab-container { position: absolute; bottom: 110px; width: 100%; display: flex; justify-content: center; pointer-events: none; z-index: 10; }
        .fab { width: 56px; height: 56px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 8px 20px rgba(0,0,0,0.6); border: none; cursor: pointer; pointer-events: auto; }
        .fab svg { width: 28px; height: 28px; fill: black !important; }

        /* MODALS & CHAT */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        #room-list { flex: 1; overflow-y: auto; padding: 20px; padding-top: 80px; padding-bottom: 60px; display: flex; flex-direction: column; gap: 12px; }
        .room-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border-left: 4px solid var(--neon-blue); }
        input { width: 100%; padding: 15px; background: #111; border: 1px solid #333; color: white; margin-bottom: 10px; border-radius: 10px; text-align: center; }
        h1, h2 { font-size: 0.8rem; letter-spacing: 5px; opacity: 0.5; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

    <div id="gps-container"><div class="dot" id="dot-0"></div><div class="dot" id="dot-1"></div><div class="dot active" id="dot-2"></div><div class="dot" id="dot-3"></div><div class="dot" id="dot-4"></div></div>

    <nav id="taskbar">
        <div class="nav-item" onclick="goTo(0)"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg></div>
        <div class="nav-item" onclick="goTo(1)"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
        <div class="nav-item active" onclick="goTo(2)"><svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg></div>
        <div class="nav-item" onclick="goTo(3)"><svg viewBox="0 0 24 24"><path d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94.63 1.5 1.98 2.63 3.61 2.96V19H7v2h10v-2h-4v-3.1c1.63-.33 2.98-1.46 3.61-2.96C19.08 10.63 21 8.55 21 8V7c0-1.1-.9-2-2-2z"/></svg></div>
        <div class="nav-item" onclick="goTo(4)"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></div>
    </nav>

    <div id="main-viewport">
        <div class="page"><h1>Missions</h1></div>
        <div class="page">
            <div style="margin: auto; width: 80%;">
                <h2>PILOTE</h2>
                <input type="text" id="username-input" placeholder="TON NOM">
                <button onclick="saveProfile()" style="width:100%; padding:15px; background:white; color:black; border-radius:10px; font-weight:900; border:none;">ACTIVER</button>
            </div>
        </div>
        <div class="page">
            <div id="carrosse-feed">
                <div class="post-card"><h2 style="margin-top:50vh">INITIALISATION DU FLUX...</h2></div>
            </div>
            <div class="fab-container">
                <button class="fab" onclick="handlePost()">
                    <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                </button>
            </div>
            <input type="file" id="file-input" style="display:none" accept="image/*">
        </div>
        <div class="page"><h1>Classement</h1></div>
        <div class="page">
            <button id="create-room-btn" onclick="openModal()" style="background:var(--neon-blue); border:none; padding:10px 15px; border-radius:20px; font-weight:900; position:absolute; top:20px; right:20px; z-index:10;">+ SALON</button>
            <div id="room-list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, updateDoc, increment, onSnapshot, collection, addDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIsxyL2jrrhvUpypSZqt4eakbZb2XR7Jk",
            authDomain: "up-t-network.firebaseapp.com",
            projectId: "up-t-network",
            storageBucket: "up-t-network.firebasestorage.app",
            messagingSenderId: "1066469813456",
            appId: "1:1066469813456:web:4b660350832ea1d95702d5",
            measurementId: "G-7CSRYYCZWV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const postsCol = collection(db, "posts");
        const roomsCol = collection(db, "rooms");
        
        let user = localStorage.getItem('up-t-user');

        // --- MOTEUR DE FEED VERTICAL ---
        onSnapshot(query(postsCol, orderBy("createdAt", "desc")), (snap) => {
            const feed = document.getElementById('carrosse-feed');
            feed.innerHTML = ""; 

            snap.forEach(docSnap => {
                const d = docSnap.data();
                const id = docSnap.id;
                const card = document.createElement('div');
                card.className = 'post-card';
                card.innerHTML = `
                    <img src="${d.photoBase64}">
                    <div class="post-info">
                        <div class="post-author">@${d.author || 'Inconnu'}</div>
                    </div>
                    <div class="vote-section">
                        <button class="vote-btn" onclick="castVote('${id}')">
                            <svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/></svg>
                        </button>
                        <div class="vote-counter">${d.votes || 0}</div>
                    </div>
                `;
                feed.appendChild(card);
            });
        });

        window.castVote = async (postId) => {
            const postRef = doc(db, "posts", postId);
            await updateDoc(postRef, { votes: increment(1) });
        };

        window.handlePost = () => {
            if (!user || user === "null") {
                alert("ðŸ”’ IDENTIFICATION REQUISE");
                goTo(1);
            } else {
                document.getElementById('file-input').click();
            }
        };

        document.getElementById('file-input').addEventListener('change', (e) => {
            const f = e.target.files[0];
            const r = new FileReader();
            r.onloadend = async () => {
                await addDoc(postsCol, {
                    photoBase64: r.result,
                    author: user,
                    votes: 0,
                    createdAt: Date.now()
                });
            };
            if(f) r.readAsDataURL(f);
        });

        // --- NAVIGATION & PROFIL ---
        window.saveProfile = () => {
            const n = document.getElementById('username-input').value.trim();
            if(n.length > 1) {
                localStorage.setItem('up-t-user', n);
                user = n;
                goTo(2);
            }
        };

        let cur = 2; let sX = 0;
        window.goTo = (i) => {
            cur = i;
            document.getElementById('main-viewport').style.transform = `translateX(${-i*100}vw)`;
            document.querySelectorAll('.dot').forEach((d,idx) => d.classList.toggle('active', idx===i));
            document.querySelectorAll('.nav-item').forEach((n,idx) => n.classList.toggle('active', idx===i));
        };

        // Swipe horizontal uniquement pour le viewport
        window.addEventListener('touchstart', e => sX = e.touches[0].clientX);
        window.addEventListener('touchend', e => {
            let dx = sX - e.changedTouches[0].clientX;
            // On bloque le swipe horizontal si on est sur la page Carrosse (index 2) pour laisser le scroll vertical libre
            if(Math.abs(dx) > 70) {
                if(dx > 0 && cur < 4) goTo(cur + 1);
                else if(dx < 0 && cur > 0) goTo(cur - 1);
            }
        });
    </script>
</body>
</html>
